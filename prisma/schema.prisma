// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

// Core: Wedding is the root entity
model Wedding {
  id             String          @id @default(uuid())
  groomFirstName String
  groomLastName  String
  brideFirstName String
  brideLastName  String
  enabledAddOns  String[]        @default([]) // e.g., ["website", "tasks", "gifts"]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // User relationships (many-to-many through UserWedding)
  userWeddings   UserWedding[]

  // Core relationships
  events         Event[]
  guests         Guest[]
  households     Household[]
  invitations    Invitation[]

  // Add-on relationships
  website        Website?
}

// Join table: Allows multiple users per wedding (co-management)
model UserWedding {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  weddingId  String
  wedding    Wedding  @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  // Role for future access control (e.g., "owner", "editor", "viewer")
  role       String   @default("owner")

  // Indicates if this is the primary/creator user
  isPrimary  Boolean  @default(false)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, weddingId])
  @@index([userId])
  @@index([weddingId])
}

// Add-on: Website (guest-facing wedding website)
model Website {
  id                String     @id @default(uuid())
  weddingId         String     @unique
  wedding           Wedding    @relation(fields: [weddingId], references: [id], onDelete: Cascade)
  url               String     @unique
  subUrl            String     @unique
  isPasswordEnabled Boolean    @default(false)
  password          String?
  isRsvpEnabled     Boolean    @default(true)
  coverPhotoUrl     String?
  generalQuestions  Question[] @relation(name: "Website_Questions")
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([weddingId])
}

// model StoryItem {
//     id             Int          @id @default(autoincrement())
//     photoUrl       String
//     title          String
//     text           String
//     homePageItemId Int
//     homePageItem   HomePageItem @relation(fields: [homePageItemId], references: [id])

//     @@index([homePageItemId])
// }

// model HomePageItem {
//     id        Int         @id @default(autoincrement())
//     websiteId String
//     title     String
//     textBlock String
//     photoUrl  String
//     gifUrl    String
//     story     StoryItem[]
// }

// Better Auth Tables
model User {
  id             String    @id
  name           String?
  email          String    @unique @db.VarChar(255)
  emailVerified  Boolean   @default(false)
  image          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Custom fields for your app
  websiteUrl     String?   @db.VarChar(255)
  groomFirstName String?
  groomLastName  String?
  brideFirstName String?
  brideLastName  String?

  sessions       Session[]
  accounts       Account[]
  userWeddings   UserWedding[]
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}

model Account {
  id                String   @id
  accountId         String
  providerId        String
  userId            String
  accessToken       String?
  refreshToken      String?
  idToken           String?
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?
  scope             String?
  password          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@unique([identifier, value])
}

// Core: Household groups guests together (families, couples, singles)
model Household {
  id             String           @id @default(uuid())
  weddingId      String
  wedding        Wedding          @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  // Mailing address for physical invitations
  address1       String?
  address2       String?
  city           String?
  state          String?
  zipCode        String?
  country        String?

  // General notes about the household
  notes          String?

  // Relations
  guests         Guest[]          @relation(name: "Household_Guests")
  gifts          Gift[]           @relation(name: "Household_Gifts")
  answers        Answer[]         @relation(name: "Household_Answers")
  optionReponses OptionResponse[] @relation(name: "Household_OptionResponses")

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([weddingId])
}

// NOTE: Contact info (email, phone) lives on Guest, not Household

model Gift {
  householdId String
  household   Household @relation(name: "Household_Gifts", fields: [householdId], references: [id], onDelete: Cascade)
  eventId     String
  event       Event     @relation(name: "Event_Gifts", fields: [eventId], references: [id], onDelete: Cascade)
  description String?
  thankyou    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@id(name: "GiftId", [householdId, eventId])
  @@index([householdId])
  @@index([eventId])
}

// Core: Individual guests (always belong to a household)
model Guest {
  id               Int              @id @default(autoincrement())
  weddingId        String
  wedding          Wedding          @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  firstName        String
  lastName         String
  email            String?          // Individual contact for notifications
  phone            String?          // Individual contact for WhatsApp/SMS

  // Every guest belongs to a household (required)
  householdId      String
  household        Household        @relation(name: "Household_Guests", fields: [householdId], references: [id], onDelete: Cascade)

  // Primary contact for the household (who manages RSVPs)
  isPrimaryContact Boolean          @default(false)

  // Relations
  invitations      Invitation[]     @relation(name: "Guest_Invitations")
  optionResponses  OptionResponse[] @relation(name: "Guest_OptionResponses")
  answers          Answer[]         @relation(name: "Guest_Answers")

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([weddingId])
  @@index([householdId])
  // not supported in postgres - TODO: ensure rsvp search functionality is unaffected
  // @@fulltext([firstName])
  // @@fulltext([lastName])
}

// Core: Wedding events (ceremony, reception, etc.)
model Event {
  id          String       @id @default(uuid())
  weddingId   String
  wedding     Wedding      @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  name        String
  date        DateTime?    @db.Date
  startTime   String?
  endTime     String?
  venue       String?
  attire      String?
  description String?
  collectRsvp Boolean      @default(false)

  // Relations
  invitations Invitation[] @relation(name: "Event_Invitations")
  gifts       Gift[]       @relation(name: "Event_Gifts")
  questions   Question[]   @relation(name: "Event_Questions")

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([weddingId])
  // subEvents   SubEvent[]   @relation(name: "Event_SubEvent")
}

// model SubEvent {
//     id          String    @id @default(uuid())
//     name        String
//     date        DateTime? @db.Date
//     startTime   String?
//     endTime     String?
//     venue       String?
//     attire      String?
//     description String?
//     eventId     String
//     event       Event     @relation(name: "Event_SubEvent", fields: [eventId], references: [id], onDelete: Cascade)

//     @@index([eventId])
// }

// website relations are the general questions
model Question {
  id         String   @id @default(uuid())
  eventId    String?
  event      Event?   @relation(name: "Event_Questions", fields: [eventId], references: [id], onDelete: Cascade)
  websiteId  String?
  website    Website? @relation(name: "Website_Questions", fields: [websiteId], references: [id], onDelete: Cascade)
  text       String
  //   type       String // idk what this is for yet tbh ['Custom', 'Kids', 'RSVPNote']
  type       String // ['Text', 'Option']
  isRequired Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  options    Option[] @relation(name: "Question_Options")
  answers    Answer[] @relation(name: "Question_Answers")

  @@index([eventId])
  @@index([websiteId])
}

model Option {
  id              String           @id @default(uuid())
  responseCount   Int              @default(0)
  text            String
  description     String
  question        Question         @relation(name: "Question_Options", fields: [questionId], references: [id], onDelete: Cascade)
  questionId      String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  optionResponses OptionResponse[] @relation(name: "Option_OptionResponses")

  @@index([questionId])
}

// for counting the number of guests that selected an option?
model OptionResponse {
  questionId     String
  option         Option     @relation(name: "Option_OptionResponses", fields: [optionId], references: [id], onDelete: Cascade)
  optionId       String
  guest          Guest?     @relation(name: "Guest_OptionResponses", fields: [guestId], references: [id], onDelete: Cascade)
  guestId        Int
  household      Household? @relation(name: "Household_OptionResponses", fields: [householdId], references: [id], onDelete: Cascade)
  householdId    String
  guestFirstName String?
  guestLastName  String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@id(name: "optionResponseId", [questionId, guestId, householdId])
  @@index([questionId])
  @@index([optionId])
  @@index([guestId])
  @@index([householdId])
}

model Answer {
  response       String
  question       Question   @relation(name: "Question_Answers", fields: [questionId], references: [id], onDelete: Cascade)
  questionId     String
  guest          Guest?     @relation(name: "Guest_Answers", fields: [guestId], references: [id], onDelete: Cascade)
  guestId        Int
  household      Household? @relation(name: "Household_Answers", fields: [householdId], references: [id], onDelete: Cascade)
  householdId    String
  guestFirstName String?
  guestLastName  String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@id(name: "answerId", [questionId, guestId, householdId])
  @@index([guestId])
  @@index([householdId])
  @@index([questionId])
}

// Core: Invitations are per-guest, per-event (not per household)
model Invitation {
  id                  String    @id @default(uuid())
  weddingId           String
  wedding             Wedding   @relation(fields: [weddingId], references: [id], onDelete: Cascade)

  guestId             Int
  guest               Guest     @relation(name: "Guest_Invitations", fields: [guestId], references: [id], onDelete: Cascade)

  eventId             String
  event               Event     @relation(name: "Event_Invitations", fields: [eventId], references: [id], onDelete: Cascade)

  // RSVP data
  rsvp                String    @default("Invited") // 'Invited', 'Attending', 'Declined', 'Not Invited'
  dietaryRestrictions String?   // Per-guest dietary needs

  // Tracking
  submittedBy         Int?      // Which guest actually submitted (usually primary contact)
  submittedAt         DateTime?
  invitedAt           DateTime  @default(now())

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([guestId, eventId])
  @@index([weddingId])
  @@index([guestId])
  @@index([eventId])
}
